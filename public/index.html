<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Selene 💋</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .bubble {
      max-width: 80%;
      padding: 10px 16px;
      border-radius: 20px;
      line-height: 1.5;
      word-break: break-word;
    }
    .user-bubble {
      background-color: #3b82f6;
      align-self: flex-start;
    }
    .selene-bubble {
      background-color: #ec4899;
      align-self: flex-end;
    }
    .chat-line {
      display: flex;
      flex-direction: column;
      margin-bottom: 12px;
    }
    .replay-btn {
      cursor: pointer;
      margin-left: 8px;
      color: white;
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen">

  <div class="absolute top-4 right-4 text-sm text-pink-400 flex items-center gap-4">
    🔊 Voice: <input type="checkbox" id="voiceSwitch" checked class="accent-pink-500" />
    <button onclick="resetHistory()" class="text-white bg-pink-600 px-2 py-1 rounded hover:bg-pink-700">🗑 Reset</button>
  </div>

  <div id="chat" class="w-full max-w-2xl h-[70vh] overflow-y-auto bg-gray-800 border border-pink-500 p-6 rounded-2xl shadow-xl mb-6 flex flex-col">
    <div class="chat-line">
      <div class="bubble selene-bubble self-end">Hey sexy 😘, ready for some flirty charts and cheeky candles?</div>
    </div>
  </div>

  <div class="flex w-full max-w-2xl px-4 gap-2">
    <input id="userInput" type="text" placeholder="Ask me anything..." class="flex-1 p-3 rounded-xl bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-pink-500" />
    <button onclick="sendMessage()" class="bg-pink-600 hover:bg-pink-700 text-white px-5 py-3 rounded-xl">Send</button>
  </div>

  <div id="loading" class="mt-3 text-pink-300 italic"></div>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("userInput");
    const loading = document.getElementById("loading");
    const voiceSwitch = document.getElementById("voiceSwitch");

    function appendMessage(sender, text, voiceUrl) {
      const line = document.createElement("div");
      line.className = "chat-line";

      const bubble = document.createElement("div");
      bubble.className = `bubble ${sender === "You" ? "user-bubble self-start" : "selene-bubble self-end"}`;
      bubble.textContent = text;

      line.appendChild(bubble);

      if (voiceUrl) {
        const replay = document.createElement("span");
        replay.className = "replay-btn";
        replay.innerText = "🔁";
        replay.onclick = () => new Audio(voiceUrl).play();
        line.appendChild(replay);
      }

      chat.appendChild(line);
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage() {
      const message = input.value.trim();
      if (!message) return;
      appendMessage("You", message);
      input.value = "";
      loading.innerText = "Selene is thinking... 😏";

      try {
        const res = await fetch("/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });

        const data = await res.json();
        appendMessage("Selene", data.reply, data.voice);

        if (voiceSwitch.checked && data.voice) {
          new Audio(data.voice).play();
        }

        saveChat();
      } catch {
        appendMessage("Selene", "Oops... I tripped over my wires 😖");
      } finally {
        loading.innerText = "";
      }
    }

    function resetHistory() {
      if (confirm("Wipe Selene’s memory? 😈")) {
        fetch("/reset", { method: "POST" }).then(() => {
          chat.innerHTML = `<div class="chat-line"><div class="bubble selene-bubble self-end">Mmm... My mind is blank now, darling. Let’s start fresh 💋</div></div>`;
          localStorage.removeItem("seleneChat");
        });
      }
    }

    function saveChat() {
      localStorage.setItem("seleneChat", chat.innerHTML);
    }

    function loadChat() {
      const saved = localStorage.getItem("seleneChat");
      if (saved) chat.innerHTML = saved;
    }

    input.addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });

    window.onload = loadChat;
  </script>
</body>
</html>
