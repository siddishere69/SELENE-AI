<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Selene ğŸ’‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .chat-line {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 1rem;
    }
    .bubble {
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      max-width: 80%;
      display: inline-block;
      position: relative;
    }
    .replay-btn {
      cursor: pointer;
      color: #ec4899;
      margin-left: 8px;
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen">

  <div class="absolute top-4 right-4 text-sm text-pink-400 flex items-center gap-4">
    ğŸ”Š Voice: <input type="checkbox" id="voiceSwitch" checked class="accent-pink-500" />
    <button onclick="resetHistory()" class="text-white bg-pink-600 px-2 py-1 rounded hover:bg-pink-700">ğŸ—‘ Reset</button>
  </div>

  <div class="w-full max-w-2xl h-[70vh] overflow-y-auto bg-gray-800 border border-pink-500 p-6 rounded-2xl shadow-xl space-y-4 mb-6" id="chat">
    <div class="chat-line">
      <div class="bubble bg-pink-700 text-white self-start">
        <strong>Selene:</strong> Hey sexy ğŸ˜˜, ready for some flirty charts and cheeky candles?
      </div>
    </div>
  </div>

  <div class="flex w-full max-w-2xl px-4 gap-2">
    <input id="userInput" type="text" placeholder="Ask me anything..." class="flex-1 p-3 rounded-xl bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-pink-500" />
    <button onclick="sendMessage()" class="bg-pink-600 hover:bg-pink-700 text-white px-5 py-3 rounded-xl">Send</button>
  </div>

  <div id="loading" class="mt-3 text-pink-300 italic"></div>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("userInput");
    const loading = document.getElementById("loading");
    const voiceSwitch = document.getElementById("voiceSwitch");
    let lastVoice = null;

    function appendMessage(sender, text, voiceUrl) {
      const wrapper = document.createElement("div");
      wrapper.className = "chat-line";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.classList.add(sender === "You" ? "bg-blue-600", "self-end" : "bg-pink-700", "self-start");
      bubble.innerHTML = `<strong>${sender}:</strong> <span>${text}</span>`;

      if (voiceUrl && sender === "Selene") {
        const replay = document.createElement("span");
        replay.className = "replay-btn";
        replay.textContent = "ğŸ”";
        replay.onclick = () => new Audio(voiceUrl).play();
        bubble.appendChild(replay);
        lastVoice = voiceUrl;
      }

      wrapper.appendChild(bubble);
      chat.appendChild(wrapper);
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage() {
      const message = input.value.trim();
      if (!message) return;
      appendMessage("You", message);
      input.value = "";
      loading.innerText = "Selene is biting her lip, thinking about your request... ğŸ˜";

      try {
        const res = await fetch("/message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });

        const data = await res.json();
        appendMessage("Selene", data.reply, data.voice);
        if (voiceSwitch.checked && data.voice) {
          const audio = new Audio(data.voice);
          audio.play();
        }
        saveChat();
      } catch (err) {
        appendMessage("Selene", "Uff, my wires crossed! Try again ğŸ˜£");
      } finally {
        loading.innerText = "";
      }
    }

    async function resetHistory() {
      const confirmed = confirm("Wipe Selene's memory? ğŸ˜");
      if (!confirmed) return;
      try {
        const res = await fetch("/reset", { method: "POST" });
        const data = await res.json();
        if (data.success) {
          chat.innerHTML = `<div class="chat-line"><div class="bubble bg-pink-700 text-white self-start"><strong>Selene:</strong> Mmm... My mind is blank now, darling. Letâ€™s start fresh ğŸ’‹</div></div>`;
          localStorage.removeItem("seleneChat");
        }
      } catch (err) {
        appendMessage("Selene", "Ugh... I forgot how to forget. Try again ğŸ˜«");
      }
    }

    function saveChat() {
      localStorage.setItem("seleneChat", chat.innerHTML);
    }

    function loadChat() {
      const saved = localStorage.getItem("seleneChat");
      if (saved) {
        chat.innerHTML = saved;
        chat.scrollTop = chat.scrollHeight;
      }
    }

    input.addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });

    window.onload = loadChat;
  </script>

</body>
</html>
